# Lenovo ThinkPad P16s

## Kernel

- A GPU bug `commit wait timed out` can be [resolved](https://gitlab.freedesktop.org/drm/amd/-/issues/2443) by upgrading the Kernel to 6.3.13, to which [the fix](https://patchwork.freedesktop.org/series/119764/) has been backported. Note that the firmware also needs to be upgraded to [any version released after 2023-06-12](https://git.kernel.org/pub/scm/linux/kernel/git/firmware/linux-firmware.git/commit/amdgpu/yellow_carp_dmcub.bin?id=9dbd8ec28fd810e5f4f9da41452aba74896a5564)
- Another GPU driven (soft) freeze bug prints to the log `[CRTC:67:crtc-0] flip_done timed out`. It is either [#2068](https://gitlab.freedesktop.org/drm/amd/-/issues/2068), or [#2220](https://gitlab.freedesktop.org/drm/amd/-/issues/2220). Both of these are unresolved.
- Kernel panics / hard freezes (without any logs) have been observed. They are very difficult to debug, but one saving grace is that they are only observed when the machine is idle. This points to a power related problem, and a systemd service to [disable the C6 state](https://aur.archlinux.org/packages/disable-c6-systemd) appears to help at the cost of battery life.
- The kernel parameter `gpiolib_acpi.ignore_interrupt='AMDI0030:00@18'` is added to prevent [GPIO PIN 18 from waking up the system from s2idle](https://gitlab.freedesktop.org/drm/amd/-/issues/2539). The wake up seems to occur every 5 minutes only when using `suspend-then-hibernate` and not during `suspend`, regardless of the status of the `ath11k_pci` driver.
- However, one bug (intended behaviour?) remains where the system wakes up from suspend whenever an AC adapter is plugged in. The converse, where the system wakes up when an AC adapter is removed, does not occur. This happens under IRQ 7 `pinctrl_amd` (followed by IRQ 9 `acpi`) from the GPIO PIN 0. However, adding that to `ignore_interrupt` prevents the keyboard from being used to wake the system up. Various combinations of these `ignore_interrupt` parameters along with `acpi.ec_no_wakeup=1` do not help either. This is also believed to be [tied to the `ath11k_pci` driver](https://bugzilla.kernel.org/show_bug.cgi?id=217239).
- Another kernel parameter `amd_pstate=passive` (or `amd_pstate=active` on kernel >= 6.3) is [added](https://wiki.archlinux.org/title/Lenovo_ThinkPad_T14_(AMD)_Gen_2#AMD_P-State) to use the AMD p-states frequency driver. The other CPU frequency driver is blacklisted using the parameter `module_blacklist=acpi_cpufreq`.

## Hardware

- Fix the microphone LED by `echo -n 7 > /sys/class/sound/card1/controlC1/led-mic/detach`, automated via a [`systemd` service](https://aur.archlinux.org/cgit/aur.git/tree/fix-tp-mic-led.service?h=thinkpad-p14s).
- The TrackPoint sensitivity can be halved by `echo 64 > /sys/devices/platform/i8042/serio1/sensitivity`, again automated via a `systemd` service. `udev` rules don't work in this case because the device appears too late in the boot process. Consequently, a direct `service` file doesn't work either; it must be routed via a [`path` file with the `PathExists` condition](https://wiki.archlinux.org/title/TrackPoint#systemd.path_unit).
- Automatically power off the keyboard backlight by using [keyboard-backlightd](https://aur.archlinux.org/packages/keyboard-backlightd). The default configuration file in `/etc/conf.d/keyboard-backlightd` works fine for this device.

## Sleep / Hibernate

- It is [not recommended](https://bbs.archlinux.org/viewtopic.php?id=249962) to use an encrypted swap partition to hibernate. This results in errors like `Delayed block allocation failed for inode X at logical offset Y with max blocks Z with error 117`. As a workaround, a swapfile may be used. Make sure to remove the `openswap` hook from `/etc/mkinitcpio.conf`.
- To enable `suspend-then-hibernate` on lid shut, add to `/etc/systemd/sleep.conf` [two parameters](https://austingwalters.com/increasing-battery-life-on-an-arch-linux-laptop-thinkpad-t14s/): `HibernateState=disk` and `HibernateDelaySec=30min`; and to `/etc/systemd/logind.conf` one parameter `HandleLidSwitch=suspend-then-hibernate`. Remember that the setting in Gnome's Tweaks to "Suspend when laptop lid is closed" [must be on](https://wiki.archlinux.org/title/GNOME#Do_not_suspend_when_laptop_lid_is_closed).
- To use `suspend-then-hibernate` when the system is idle, [Gnome is a blocker](https://gitlab.gnome.org/GNOME/gnome-settings-daemon/-/issues/583). As a workaround, `ln -s --force /usr/lib/systemd/system/systemd-suspend-then-hibernate.service /etc/systemd/system/systemd-suspend.service` will result in `suspend-then-hibernate` in place of `suspend` when it is triggered by Gnome (or anyone). You can change the timeouts to values outside of those offered by Gnome UI by using the `dconf Editor` in the path `org.gnome.settings-daemon.plugins.power`.
- While resuming from suspend, the `ath11k_pci` driver is buggy and sometimes results in black screen which may/may not return to the DE after waiting. To prevent this, `modprobe -r` the driver before `suspend.target` and `suspend-then-hibernate.target`, and `modprobe` it afterwards. The driver version tested is `WLAN.HSP.1.1-03125-QCAHSPSWPL_V1_V2_SILICONZ_LITE-3.6510.23`, and while it is [believed by AMD to work fine](https://gitlab.freedesktop.org/drm/amd/-/blob/20742abc8bc99816f805359f2ac55e64ce7eb892/scripts/amd_s2idle.py#L386), it is still under investigation (see [Kernel](#kernel) above).
