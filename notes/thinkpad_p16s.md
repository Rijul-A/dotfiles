# Lenovo ThinkPad P16s

## Kernel

There have been a multitude of bugs faced with varying Kernel versions.

- One bug [related to PSR](https://gitlab.freedesktop.org/drm/amd/-/issues/2443) was fixed in firmware upgrade [9dbd8ec28fd810e5f4f9da41452aba74896a5564](https://git.kernel.org/pub/scm/linux/kernel/git/firmware/linux-firmware.git/commit/amdgpu/yellow_carp_dmcub.bin?id=9dbd8ec28fd810e5f4f9da41452aba74896a5564). An associated [Kernel fix](https://patchwork.freedesktop.org/series/119764/) was introduced and backported to stable 6.3.13. The bug results in sometimes recoverable graphics freezes, and is seen in the Kernel log as `[CRTC:67:crtc-0] flip_done timed out`, `commit wait timed out` and `[CONNECTOR:78:eDP-1]`.
- [Another bug I faced only once](https://gitlab.freedesktop.org/drm/amd/-/issues/2006) is claimed to be solved in Kernel 6.4(.12). It has similar symptoms as the previous bug, but the log lines are `flip_done timed out` and `[CRTC:67:crtc-0] commit wait timed out`.
- One bigger, more frequently occurring bug, resulted in [irrecoverable graphics freezes](https://gitlab.freedesktop.org/drm/amd/-/issues/2443) possibly due to Kernel panics. These were noticed more frequently around the time the system went to idle. This one has not yet been fixed or worked around or even consistently reproduced on Linux in any manner but getting rid of DKMS modules helps. In other words, the output of `dkms status` must be blank.
- The `ath11k_pci` firmware causes spurious wake ups, see the [Sleep / Hibernate](#sleep--hibernate) section below. In addition to these, I noticed wake ups caused by GPIO PIN 0 as IRQ 7 `pinctrl_amd` followed by IRQ 9 `acpi` only when using `suspend-then-hibernate` but not when using `suspend`. I disabled both of these pins and the GPE floodings by adding parameters `gpiolib_acpi.ignore_interrupt=AMDI0030:00@18,AMDI0030:00@0` and `acpi_mask_gpe=0x0B`. The `0x0B` was discovered by running the AMD provided `amd_s2idle.py` script with reported that `gpe0B increased`.
- The CPU frequency driver can (and should be) changed to `amd_pstate` by adding Kernel parameters `module_blacklist=acpi_cpufreq` and `amd_pstate=active`.

## Hardware

- Fix the microphone LED by `echo -n 7 > /sys/class/sound/card1/controlC1/led-mic/detach`, automated via a [`systemd` service](https://aur.archlinux.org/cgit/aur.git/tree/fix-tp-mic-led.service?h=thinkpad-p14s).
- The TrackPoint sensitivity can be halved by `echo 64 > /sys/devices/platform/i8042/serio1/sensitivity`, again automated via a `systemd` service. `udev` rules don't work in this case because the device appears too late in the boot process. Consequently, a direct `service` file doesn't work either; it must be routed via a [`path` file with the `PathExists` condition](https://wiki.archlinux.org/title/TrackPoint#systemd.path_unit).
- Automatically power off the keyboard backlight by using [keyboard-backlightd](https://aur.archlinux.org/packages/keyboard-backlightd). The default configuration file in `/etc/conf.d/keyboard-backlightd` works fine for this device.

## Sleep / Hibernate

- The laptop is not super great at hardware sleep residency, which is close to 75% as opposed to the expected value of 90%. This is even after adding the Kernel parameters discussed previously. By myself, I could not determine why this happens so I chose to go for `suspend-then-hibernate` as a solution.
- However, hibernation using an encrypted swap partition is [not recommended](https://bbs.archlinux.org/viewtopic.php?id=249962). This results in errors like `Delayed block allocation failed for inode X at logical offset Y with max blocks Z with error 117`. As a workaround, a swapfile is used.
- To enable `suspend-then-hibernate` on lid shut, add to `/etc/systemd/sleep.conf` [a parameter](https://austingwalters.com/increasing-battery-life-on-an-arch-linux-laptop-thinkpad-t14s/): `HibernateDelaySec=30min`; add to `/etc/systemd/logind.conf` one parameter `HandleLidSwitch=suspend-then-hibernate`. Remember that the setting in Gnome's Tweaks to "Suspend when laptop lid is closed" [must be on](https://wiki.archlinux.org/title/GNOME#Do_not_suspend_when_laptop_lid_is_closed).
- To use `suspend-then-hibernate` when the system is idle, [Gnome is a blocker](https://gitlab.gnome.org/GNOME/gnome-settings-daemon/-/issues/583). As a workaround, `ln -s --force /usr/lib/systemd/system/systemd-suspend-then-hibernate.service /etc/systemd/system/systemd-suspend.service` will result in `suspend-then-hibernate` in place of `suspend` when it is triggered by Gnome (or anyone). You can change the timeouts to values outside of those offered by Gnome UI by using the `dconf Editor` under the path `org.gnome.settings-daemon.plugins.power`.
- While resuming from suspend and hibernate, the `ath11k_pci` driver is buggy and sometimes results in black screen which may/may not return to the DE after waiting. To prevent this, `modprobe -r` the driver before `suspend.target`, `suspend-then-hibernate.target` and `hibernate.target`, and `modprobe` it afterwards using a [systemd service](services/remove-mod-on-suspend@.service). The driver version tested is `WLAN.HSP.1.1-03125-QCAHSPSWPL_V1_V2_SILICONZ_LITE-3.6510.23`, and while it is [believed by AMD to work fine](https://gitlab.freedesktop.org/drm/amd/-/blob/20742abc8bc99816f805359f2ac55e64ce7eb892/scripts/amd_s2idle.py#L386), it is still [under investigation](https://bugzilla.kernel.org/show_bug.cgi?id=217239).
